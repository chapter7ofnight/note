#### 一、分析器

##### 1、Character Filter

​		处理文本中的特殊字符。

##### 2、Tokenizer

​		将文本按一定的规则分成一组词。

##### 3、Token Filter

​		过滤无意义的词，转换词的形式。



#### 二、评分

##### 1、检索词频率

​		词语出现在被搜索文档字段中的频率

##### 2、反向文档频率

​		当有多个检索词时，出现频率更低的那个词有更高的得分

##### 3、字段长度准则

​		被搜索文档字段的长度越小，得分越高



#### 三、内部原理

##### 1、集群

​		ES 是天生的分布式的组件，在配置文件中指定相同的 cluster.name，然后配置所有集群内的节点 IP 和端口，即可把这些节点组成集群。配置 node.master 属性为 true 的节点可以被选举成为 master 节点。

​		集群内只允许有一个 master 节点，所以选举 master 节点时应得到多数节点的认可，由参数 discovery.zen.minimum_master_nodes 控制。

​		master 节点负责监控集群的状态，管理集群中的节点，增加或删除索引。

##### 2、选举 master 节点

​		包括自己在内的多数 master-eligible 节点认为集群内没有 master 节点时，会发起 master 节点选举。

​		选举的优先级是 clusterStateVersion 越大，优先级越高；其次，启动 ID 越小，优先级越高。

##### 3、分片

​		分片是 ES 内部数据管理的最小单位。一个索引可以分为若干个主分片，这个数量在创建索引时确定，不可更改。ES 默认根据 ID 的 hash 值，来确定一个文档应该属于哪个主分片。每个主分片可以有相同个数的副本分片，保存和主分片完全一样的数据，作为数据备份和读的负载均衡。

##### 4、读写

a）写。原始文档直接写入磁盘

​		索引数据先写入内存 buffer，此时还不能被搜索，同时写入 translog 日志。当 buffer 太大，或者一定时间之后（默认 1s），buffer 会往磁盘上一个新的 segment 文件 refresh，然后数据可以被搜索。

​		应用写文件的时，操作系统会先写入 os cache 中，断电会导致数据丢失。translog 默认每 5s 刷新到磁盘，数据默认每 30m flush 一次。当 segment 数量比较大时，ES 会自动合并大小相似的段。

b）读。

​		搜索默认使用 query then fetch 方式。先在各个分片上 query，返回 id 和评分信息等，然后集中对这些文档再次进行计算排序，得到最终所需要的 id；根据 id 去 fetch 原始数据。

​		根据 id 检索时直接 fetch 即可。

